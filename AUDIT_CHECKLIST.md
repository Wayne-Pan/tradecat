# 优化项验收与审计清单
> 版本：2026-01-03T05:05:09+08:00  
> 适用范围：当前仓库的性能/成本与安全优化项  
> 用法：实施每项任务时，先对照“验收标准”，完工后由独立审计按“审计要点”复核

## 简单（S）
### 1) 日志轮转与压缩
- 验收标准
  - 日志按天轮转，至少保留 7–14 天并 gzip。
  - 手动/定时轮转后，新日志可继续写入，无错误日志。
  - 磁盘占用随时间下降，无连续增长的未压缩文件。
- 审计要点
  - logrotate/内置配置路径与实际日志目录一致；守护脚本轮转后无 stale fd。
  - 采样检查最近与过期的压缩文件存在且大小合理。

### 2) 安全加载 .env + 权限检查
- 验收标准
  - start.sh 仅解析 KEY=VALUE，拒绝含空格、多个 `=`、`export`/`$(`/反引号的行。
  - `.env` 权限非 600 时启动失败并提示。
  - 注入用例 `ECHO_TEST='$(whoami)'` 不被执行，环境变量未污染。
- 审计要点
  - 代码中无 `source .env`，存在专用解析函数。
  - `stat config/.env` 权限为 600；负面用例退出码非 0，日志含拒绝原因。

### 3) SYMBOLS_* 正则校验
- 验收标准
  - 对 `SYMBOLS_GROUP*`、`SYMBOLS_EXTRA`、`SYMBOLS_EXCLUDE` 的每个值应用 `^[A-Z0-9]+USDT$`（小写先 upper）。
  - 非法值启动即失败并提示键名与值。
- 审计要点
  - 日志/测试覆盖非法样例；无静默忽略路径。

### 4) 时间戳比较使用 datetime
- 验收标准
  - `services/telegram-service/src/cards/data_provider.py::fetch_metric` 使用 datetime 对象比较，支持 Z/+00:00/无 tz。
  - 解析失败的记录被 warning 后跳过；输出无重复/漏项。
- 审计要点
  - 代码中不存在字符串比较时间戳；日志有解析失败的 warning 入口。

## 中等（M）
### 5) 代理自检与切换
- 验收标准
  - 启动 3s 内对 Binance `/ping` 探测；失败清空代理或从 `PROXY_LIST` 选首个可用。
  - 坏代理场景下服务可继续拉数据；好代理场景额外启动延迟 <1s。
- 审计要点
  - 断网/坏代理测试：日志出现“代理不可用，已禁用/切换”；功能不中断。

### 6) SQLite 连接复用
- 验收标准
  - 排行榜查询使用 1–3 个只读长连，`check_same_thread=False`，失效自动重建。
  - 并发压测延迟下降，无 “too many open files”/锁错误；连接被 kill 后自动恢复。
- 审计要点
  - 代码通过池/单例取连接；故障注入（kill 连接）后恢复正常。

### 7) IO/CPU 拆分执行器
- 验收标准
  - 任务带类型标记；IO 线程池，CPU 进程池；并行度可配置。
  - CPU 任务多核利用提升、耗时下降；IO 任务不被 GIL 卡。
- 审计要点
  - 调度配置覆盖主要任务；压测无死锁/僵尸进程；跨进程未传递大对象。

## 中-高（M-L）
### 8) 批量拉 K 线 / 批量算指标
- 验收标准
  - 抓取：同周期多币种批次请求（如 20/批或交易所批量端点），写 TimescaleDB 用多值 insert/COPY。
  - 计算：同周期多 symbol 向量化，保留单币兜底并监控批量失败率。
  - 性能对比：吞吐/带宽/CPU 明显优于基线；数据一致性回归通过。
- 审计要点
  - 抽样对比批量 vs 旧路径结果一致；失败降级路径实际可触发；监控中有批量失败率指标。

### 9) TimescaleDB 压缩策略
- 验收标准
  - 目标表启用 compress 属性；policy：热数据 30 天不压缩，30 天后自动压缩；可选 180 天删除/退役。
  - `compressed_chunk_stats` 显示压缩率达预期；常用时间窗查询无显著变慢。
- 审计要点
  - 审阅 DDL/policy 确认生效；冷热查询各取样一次，性能差异在可接受范围。
